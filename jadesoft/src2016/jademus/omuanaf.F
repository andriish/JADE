C   01/02/84 603201524  MEMBER NAME  OMUANAF  (JADEMUS)     FORTRAN
C
C-----------------------------------------------------------------------
      SUBROUTINE MUANAF
C-----------------------------------------------------------------------
C
C LAST CHANGE 15.25 20/03/86 CHRIS BOWDERY - MOVE NREGS TEST TO LATER ON
C      CHANGE 16.00  9/03/84 CHRIS BOWDERY - CHECK THAT NREGS > 0
C      CHANGE 14.00 26/01/84 TIM GREENSHAW - MU BANKS LOC. WITH CLOC.
C                      VARIABLE JBANK INTRO. TO IMPROVE ERROR OUTPUT.
C      CHANGE 15.30 18/01/84 TIM GREENSHAW - ERROR PRINTOUT ALTERED
C      CHANGE 15.00 30/05/83 HUGH MCCANN - IF EBGEV = 0. , SET IT TO 50.
C                                          ..... FOR COSMIC RUNS.
C      CHANGE 10.00 24/05/82 HUGH MCCANN - TRIVIAL SPELLING MISTAKE.
C                                          EBGEV NOW CHECKED FOR > 50  .
C      CHANGE 23.00 22/02/82 HUGH MCCANN - FOR IMPROVED ERROR OUTPUT.
C      CHANGE 12.00 04/02/82 HUGH MCCANN -- TO MAKE NTPH=4.
C
C-----------------------------------------------------------------------
C
C THIS ROUTINE FOLLOWS INNER DETECTOR TRACKS TO FIND ASSOCIATED MUON
C   CHAMBER HITS AND STORES RESULTS IN 'MUR2' BANKS 0 - 6.
C NOTE THAT IF NO INNER DETECTOR TRACKS ARE PRESENT ONLY BANK 0 IS
C   CREATED.
C
C NOTE ALSO THAT BANK 0 IS CREATED WHETHER OR NOT ANY MUON HITS EXIST.
C
C-----------------------------------------------------------------------
C
      IMPLICIT INTEGER*2 (H)
C
C COMMONS.
C
#include "cmubcs.for"
#include "cmureg.for"
#include "cmucalib.for"
#include "cmufwork.for"
#include "cmustat.for"
C
C-----------------------------------------------------------------------
C
C DATA INITIALISATION STATEMENTS.
C
      DATA NWMUR/38/
C NWMUR IS NUMBER OF WORDS PER INNER DETECTOR TRACK IN 'MUR2' BANK 1.
      DATA NTPH/4/
C NTPH IS NUMBER OF TRACKS PER HIT ALLOCATED IN 'MUR2' BANKS 2 AND 3.
      DATA NPL/5/
C NPL IS NUMBER OF POINTS PER EXTRAPOLATED INNER DET. TRACK IN BANK 4.
C
C-----------------------------------------------------------------------
C
C FIND MAGNETIC FIELD FROM HEADER.
      IP=IDATA(IBLN('HEAD'))
      BGAUSS=HDATA(2*IP+30)
C FIND BEAM ENERGY - IN GEV!!!!!!
      EBGEV=EBEAM(HDATA(2*IP+10))/1000.
C  COSMIC RUNS HAVE ZERO BEAM ENERGY .  SET EBGEV TO 50. IN THAT CASE.
      IF(EBGEV.EQ.0.)EBGEV=50.
C
C  TEST THAT BEAM ENERGY IS BETWEEN 1.0 AND 50.0 GEV .
      IEBGEV=INT(EBGEV)
      IF(EBGEV.LT.1..OR.EBGEV.GT.50.)
     +CALL MUERRY('MUANAF',IEBGEV,' = BEAM ENERGY !!^')
      NTRKS=0
C
C-----------------------------------------------------------------------
C
C FIND 'PATR' POINTER.
C
 1    CONTINUE
      IPPATR=IDATA(IBLN('PATR'))
      IF(IPPATR.LE.0)GO TO 3
      NTRKS=IDATA(IPPATR+2)
      NWTRK=IDATA(IPPATR+3)
      ISTART=IDATA(IPPATR+1)+1
C
C-----------------------------------------------------------------------
C
C FIND MUON COORDINATE BANK.
C
 2    CONTINUE
C
C   BANK NUMBERS OF MUR1 BANKS IN JBANK, OF MUR2 BANKS IN IBANK.
C
      JBANK=0
      CALL CLOC(IMUR10,'MUR1',JBANK)
C
C IF MUR1 DOES NOT EXIST ( IN PRINCIPLE NOT POSSIBLE, IF MUANAC IS USED)
C THEN GOT TO 3.
C
      IF(IMUR10.LE.0)GO TO 3
C

C PICK UP NO. OF HITS.
C
      NHITS=IDATA(IMUR10+1)
C
C PICK UP NO. OF WORDS PER HIT.
C
      NWHIT=IDATA(IMUR10+3)
C
C PICK UP COORDINATE BANK, 'MUR1' BANK 1.
C
      JBANK=1
      CALL CLOC(IMUR11,'MUR1',JBANK)
C
C  NO MUR1/1 BANK FOR THIS EVENT IMPLIES THAT MU-FILTER WAS NOT
C  OPERATIONAL, OR SIGNAL-COORDINATE CONVERSION HAS NOT BEEN DONE .
C  OR MAYBE MUON TRACKING WAS NOT DONE IF THIS IS MONTE CARLO.
C  BUT WANT TO MAKE MUR2/0 ANYWAY.
C
      IF(IMUR11.LE.0)GO TO 3
C
C PICK UP HIT STATUS BANK, 'MUR1' BANK 2.
C
      JBANK=2
      CALL CLOC(IMUR12,'MUR1',JBANK)
C
C-----------------------------------------------------------------------
C
C CREATE 'MUR2' RESULTS BANKS.
C
 3    CONTINUE
C
C ADD 'MUR2' TO SPECIAL LIST READY FOR WRITING.
C
      CALL BSAW(1,'MUR2')
      IBANK=0
      CALL CCRE(IMUR20,'MUR2',IBANK,4,IER)
      IF(IER.NE.0)GO TO 96
      IDATA(IMUR20+1) = NTRKS
      IDATA(IMUR20+2) = NWMUR
      IDATA(IMUR20+3) = NTPH
      IDATA(IMUR20+4) = NPL
C
      IF( NREGS .LE. 0 ) GO TO 94
C
      IF(IPPATR.LE.0)GO TO 98
C
      IF(IMUR10.LE.0)GO TO 97
C
      IF(IMUR11.LE.0.OR.IMUR12.LE.0)GO TO 975
C
      IF(NTRKS.LE.0)GO TO 99
C
C MAIN RESULTS BANK.
C
      IBANK=1
      CALL CCRE(IMUR21,'MUR2',IBANK,NTRKS*NWMUR,IER)
      IF(IER.NE.0)GO TO 96
C
C HIT-TRACK CORRELATION BANK.
C
      IBANK=2
      CALL CCRE(IMUR22,'MUR2',IBANK,(NTPH*NHITS+1)/2,IER)
      IF(IER.NE.0)GO TO 96
C
C HIT-TRACK AMBIGUITY BANK.
C
      IBANK=3
      CALL CCRE(IMUR23,'MUR2',IBANK,(NTPH*NHITS+1)/2,IER)
      IF(IER.NE.0)GO TO 96
C
C EXTRAPOLATED TRACK POINTS BANK.
C
      IBANK=4
      CALL CCRE(IMUR24,'MUR2',IBANK,3*NPL*NTRKS,IER)
      IF(IER.NE.0)GO TO 96
C
C-----------------------------------------------------------------------
C
C TRY IT. (HERE FOLLOWS THE INTRODUCTION TO MUFFLE FOR REFERENCE.)
C     SUBROUTINE MUFFLE(IPATR,APATR,NTRKS,NWTRK,
C    * BGAUSS,
C    * HC,NHITS,NWHIT,
C    * HLUN,
C    * IMUR,AMUR,NWMUR,
C    * HTC,HAMB,NTPH,
C    * EXTRA,NPL,EBEAM)
C
C     IMPLICIT INTEGER*2 (H)
C
C     DIMENSION IPATR(1),APATR(1),
C    * HC(1),
C    * HLUN(1),
C    * IMUR(1),AMUR(1),
C    * HTC(1),HAMB(1),
C    * EXTRA(1)
C
C-----------------------------------------------------------------------
C
C IPATR,APATR IS PATT. REC. DATA (SEE JADE COMP. NOTE 12, 23/2/79.)
C NTRKS IS NUMBER OF TRACKS.
C NWTRK IS NUMBER OF WORDS PER TRACK.
C BGAUSS IS MAGNETIC FIELD IN GAUSS.
C HC CONTAINS MUON HIT COORDINATES.
C NHITS IS THE NUMBER OF MUON HITS.
C NWHIT IS NUMBER OF WORDS PER HIT IN HIT COORDINATE ARRAY.
C HLUN IS HIT STATUS ARRAY.
C IMUR,AMUR IS MU-RESULTS 'MUR2' BANK 1 - FILLED BY MUFFLE.
C NWMUR IS NUMBER OF WORDS PER INNER DTECTOR TRACK IN 'MUR2' BANK 1.
C HTC IS HIT-TRACK CORELLATION ARRAY - FILLED BY MUFFLE.
C HAMB IS AMBIGUITY FLAG FOR EACH ENTRY IN HTC.
C NTPH IS NUMBER OF TRACKS PER HIT ALLOCATED IN HTC.
C EXTRA STORES THE POINTS ON THE EXTRAPOLATED TRACK.
C NPL IS THE NUMBER OF POINTS PER EXTRAPOLATED TRACK.
C EBEAM IS THE BEAM ENERGY IN GEV.
C
      CALL MUFFLE(IDATA(IPPATR+ISTART),IDATA(IPPATR+ISTART),
     + NTRKS,NWTRK,
     + BGAUSS,
     + IDATA(IMUR11+1),NHITS,NWHIT,
     + IDATA(IMUR12+1),
     + IDATA(IMUR21+1),IDATA(IMUR21+1),NWMUR,
     + IDATA(IMUR22+1),IDATA(IMUR23+1),NTPH,
     + IDATA(IMUR24+1),NPL,EBGEV)
C
C-----------------------------------------------------------------------
C
C NOW ADD BANK 5, THE MULTIPLE SCATTERING ELIPSES.
C
      IBANK=5
      CALL CCRE(IMUR25,'MUR2',IBANK,NELIPS,IER)
      IF(IER.NE.0)GO TO 96
      CALL UCOPY(ELIPSE,IDATA(IMUR25+1),NELIPS)
C
C-----------------------------------------------------------------------
C
C NOW ADD BANK 6, THE BAD CHAMBER LIST.
C
      NBADCH=0
      DO 6 I=1,NCHAMS
      IF(HMCSTA(I).EQ.0)GO TO 6
      NBADCH=NBADCH+1
      HBADCH(NBADCH)=I
 6    CONTINUE
      IF(MOD(NBADCH,2).NE.0)HBADCH(NBADCH+1)=0
      IBANK=6
      NBADC2=(NBADCH+1)/2
      CALL CCRE(IMUR26,'MUR2',IBANK,NBADC2,IER)
      IF(IER.NE.0)GO TO 96
      CALL UCOPY(HBADCH,IDATA(IMUR26+1),NBADC2)
C
C-----------------------------------------------------------------------
C
      GO TO 99
C
C-----------------------------------------------------------------------
C
C ERROR CONDITIONS.
C
 94   CALL MUERRY('MUANAF',0,'MU ANALYSIS ABORTED - NO MU REGIONS FOUND.
     + NO CALIBRATION?^')
      GO TO 99
C
 95   CALL MUERRY('MUANAF',IBANK,' = I, NOT ENOUGH SPACE FOR ''MUR2/I''.
     +^')
      GO TO 99
C
 96   IF(IER.GT.1)GO TO 95
      CALL MUERRY('MUANAF',IBANK,' = I, ''MUR2/I'' ALREADY PRESENT.^')
      GO TO 99
C
 97   NMU(10)=NMU(10)+1
      CALL MUERRY('MUANAF',JBANK,' = I, ''MUR1/I'' NOT LOCATED. HAS MUAN
     +AC BEEN CALLED?^')
      GO TO 99
C
 975  IF (NHITS .LE. 0) GO TO 99
      NMU(4) = NMU(4) + 1
      CALL MUERRY('MUANAF',JBANK,' = I, ''MUR1/I'' EXPECTED BUT MISSING,
     + SERIOUS ERROR.^')
      GO TO 99
C
 98   CALL MUERRY('MUANAF',0,'''PATR'' NOT LOCATED.^')
      NTRKS=0
      GO TO 3
C
C-----------------------------------------------------------------------
C
 99   CONTINUE
      RETURN
      END
