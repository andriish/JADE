C   12/02/82 204191829  MEMBER NAME  MNPAIR   (S)           FORTRAN
      SUBROUTINE MNPAIR
C
      INTEGER *2 HDATA,HEADR(108)
      COMMON /CHEADR/ IHEADR(54)
      EQUIVALENCE (IHEADR(1),HEADR(1))
      COMMON/BCS/IDATA(30000)
      DIMENSION RDATA(6000),HDATA(12000),PH(10),SIG(3)
      EQUIVALENCE(IDATA(1),RDATA(1)),(HDATA(1),IDATA(1))
C
      COMMON/ENRGMG/BENGEV,BKGAUS,EGCOR
      COMMON/CIOUNI/IUNIT,JUNIT,NCALI,KUNITA(10),LUNITA(10)
      COMMON/CGRAPH/ JUSCRN
      COMMON/EVRUN/NRUN,IEV,ITYP,NEV,IMISS
      COMMON/FLAGS/HISTFL,PRFL,NPRLIM
      COMMON/INOUT/WRITFL,EVWRIT
      LOGICAL WRITFL,EVWRIT,HISTFL,PRFL
      DIMENSION IBERR(10)
      DIMENSION MASK(16)
      DIMENSION LRUN(20)
C
      DATA NUN/2/
      DATA MASK/1,2,4,8,16,32,64,128,256,512,1024,2048,4096,8192,
     1          16384,32768/
      DATA MCOL/Z7000/
C
      READ 501,HISTFL,PRFL,NPRLIM
  501 FORMAT(3I5)
      PRINT 502,HISTFL,PRFL,NPRLIM
  502 FORMAT(' FLAGS',2L10,I10)
      NCALI = 2
      KUNITA(1) = 10
      KUNITA(2) = 11
      LUNITA(1) = 21
      LUNITA(2) = 22
      JUSCRN = 6
C
      CALL SETSL(IBERR,0,40,0)
      IWRITE =0
      IFILE = 0
      NUMRUN = 0
      NBHABH = 0
      WRITFL = .FALSE.
      WRITFL = .TRUE.
      CALL BINT(30000,4000,500,0)
      IF(WRITFL) CALL BWRO(3,1558,2)
      CALL STBUK(40000)
      CALL HBOOK1 (800,20HTRIGGERWORD        $,40,0.,40.)
      NAC = 0
      NEV = 0
      LL = 0
      IRUN = 0
      NHERE = 0
      IFIRST = 0
C
C  LOCATE BOS BANKS
C
      IQPATR = IBLN('PATR')
      IQTOF = IBLN('ATOF')
      IQHEAD = IBLN('HEAD')
      IQTOFR = IBLN('TOFR')
      IQLTCH = IBLN('LATC')
      IQCLST = IBLN('LGCL')
      IQT1 = IBLN('TRIG')
C
      DO   1   N=1,50000
  77  CONTINUE
      EVWRIT = .FALSE.
      IF(IUHR(5).NE.1)  GOTO  7002
      CALL BSLT
      CALL BDLG
      CALL BREAD(NUN,*1000,*7000)
C
      IPHEAD = IDATA(IQHEAD)
      IF(IPHEAD.LE.0)  GOTO  2000
      DO   55   L=1,100
      HEADR(L) = HDATA(IPHEAD*2-8+L)
   55 CONTINUE
      NRUN = HDATA(IPHEAD*2+10)
      NEV = NEV + 1
C     IF(NRUN.LE.10362)  GOTO  2
      IEV=HDATA(2*IPHEAD+11)
C WATERLEAK
      IF(NRUN.GE.3560.AND.NRUN.LT.3728)  GOTO  2
C FLAT CABLES INTER CHANGED 25-21  29-35
      IF(NRUN.GE.5064.AND.NRUN.LT.5141)  GOTO  2
      IGAUS = HDATA(IPHEAD*2+30)
      BKGAUS = FLOAT(IGAUS)/1000.
      BENGEV = 0.001*HDATA(IPHEAD*2+29 )
      EGCOR = EBEAM(HDATA(IPHEAD*2+10))/1000.
      CALL HF1(111,BKGAUS,1.)
      CALL HF1(112,BENGEV,1.)
      IF(NRUN.EQ.IRUN)  GOTO  74
      LL = LL + 1
      LRUN(LL) = NRUN
      IF(LL.LT.20)  GOTO  73
      LL = 0
      NUMRUN = NUMRUN + 1
      PRINT 704,LRUN
  704 FORMAT('  RUNS  ',20I6)
      CALL SETSL(LRUN,0,80,0)
   73 IF(NUMRUN.GT.1) GOTO  74
      CALL KLREAD(KALRET)
      IF(KALRET.NE.0) GOTO 300
   74 IRUN = NRUN
      ITYP=HDATA(2*IPHEAD+12)
      IF(ITYP.GE. 64) GOTO  2
C
C  SELECT COLLINEAR TRIGGERS
C
      IPT1 = IDATA(IQT1)
      IANDOR = 0
      IF(IPT1.LE.0)  GOTO  2002
      I1ACC = HDATA(IPT1*2+8)
      IPOST = HDATA(IPT1*2+9)
      ICOLL = IAND(IPOST,MCOL)
C FILL TRIGGER HISTOGRAM
      DO  21   L=8,9
      IANDOR = HDATA(IPT1*2+L)
      DO  21   I=1,16
      IBIT = IAND(IANDOR,MASK(I))
      IF(IBIT.EQ.0)  GOTO 21
      CALL HF1(800,FLOAT(I)+FLOAT(L-8)*16.,1.)
   21 CONTINUE
      IF(NEV.LE.10) PRINT 100,I1ACC,IPOST,ICOLL,I1ACC,IPOST,ICOLL
  100 FORMAT(' I1ACC,IPOST ',3I10,3(2X,Z10))
C     IF(ICOLL.EQ.0)  GOTO  2
      NAC = NAC + 1
      CALL BLOC(IPTOF,'ATOF',0,*400)
      CALL TOFSMP(NRUN)
      CALL COMPR(NRUN)
C     IF(NEV.LE.3) CALL ATOFPR(IPTOF)
      IF(NAC.LE.3) CALL PRSMP
      CALL TFPAIR(MCOSM)
      IF(MCOSM.LE.0)  GOTO  2
   22 IWRITE = IWRITE+ 1
      IF(IWRITE.GT.100) GOTO  2
      IF(.NOT.WRITFL) GOTO  2
C     CALL BSAW(1,'TOFR')
      CALL BSLW
      CALL BWRITE(3)
      GOTO  1
   17 CONTINUE
    2 GOTO  1
 3000 PRINT 3010
 3010 FORMAT(' ERROR RETURN FROM TOFINT')
      GOTO  2
 3001 PRINT 3011
 3011 FORMAT(' ERROR RETURN FROM TOFMAS')
      GOTO  2
2000  IBERR(1) = IBERR(1) + 1
      GOTO 77
2002  IBERR(2) = IBERR(2) + 1
      GOTO 77
2003  IBERR(3) = IBERR(3) + 1
      GOTO 77
2004  IBERR(4) = IBERR(4) + 1
      GOTO 77
2005  IBERR(5) = IBERR(5) + 1
      GOTO  77
 400  IBERR(6) = IBERR(6) + 1
      GOTO  77
 401  IBERR(7) = IBERR(7) + 1
      GOTO  77
 402  IBERR(8) = IBERR(8) + 1
      GOTO  77
      IMISS = 0
 1000 PRINT 1001,I
 1001 FORMAT(' ERROR IN BREAD  I=',I3)
    1 CONTINUE
      GOTO  7000
C
 7002 PRINT 777
      PRINT 777
      PRINT 777
  777 FORMAT('  ********   TIMELIMIT   ********')
 7000 PRINT 704,(LRUN(L),L=1,LL)
      WRITE(6,7001)NEV,NAC
C
 7001 FORMAT(' NEV=',I8,' NAC =',I8)
      PRINT 7003,IBERR
 7003 FORMAT(//' BOS ERRORS ',10I10/)
C
C  WRITE LAST EVENT
C
      CALL BMLT(0,DUMMY)
      CALL BWRITE(3)
      CALL BSTA
      PRINT600,IWRITE
  600 FORMAT(//' EVENTS WRITTEN ',I10)
      CALL HISTDO
      RETURN
  300 PRINT 301,NRUN,KALRET
  301 FORMAT(' CALIBRATION TROUBLES FOR RUN ',I6,' KALRET = 'I5)
      RETURN

      END
