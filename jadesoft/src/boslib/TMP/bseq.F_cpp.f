C   07/06/96 606071833  MEMBER NAME  BSEQ     (S4)          FORTG1
      SUBROUTINE BSEQ(MARK)
C     BOS SUBPROGRAM =3.9=
C   18/10/82            MEMBER NAME  ACS      (S)           FORTRAN
      COMMON/ACS/
     1   ICOND,NLAST,NDUMP,NSPL,NAMAX,NAMAX1,NLIST,NPRIM,NFRS,NLST,
     2   NEXT,NCI,NFRE,IN,KPOS,LIND,ILOW,LFDI,LFDK,NCPL,
     3   NHISTH(11),
     4        NCOL,NZT,IBFI,NLAST1,ISLST,IMLST,INAMV,IOLST,IPLST,
     5   NER(10),
     6   NRECL,NERRL,NRIN,NROUT,NS,NEXTI,NEXTA,NEXTB,ISAVB,NSAVB,
     7   NHISTL(11),
     8        MARKWR,NOUT(3),IASW,NPRE,IDUMMY(1),NEOTP,NDUMP1
      COMMON/BCS/IW(1)
      INTEGER LIMSEC/2/,LIMREC/0/
      IF(MARKWR.GE.0) GOTO 2
C     INITIALIZE
      I=JUHR(LIMSEC)
      NREC=0
      WRITE(6,101) LIMREC,LIMSEC
      MARKWR=0
      CALL ASMD(IASW)
    2 MARK=0
      IF(MARKWR.EQ.0) GOTO 20
C----- OUTPUT - WRITE LAST EVENT, IF MARKED
      CALL BSLW
      DO 14 I=1,MARKWR
      IUN=NOUT(I)
      IF(IUN.LE.0) GOTO 14
   10 CALL BWRS(IUN,NBUFL,INIW)
      IF(INIW.EQ.0) GOTO 12
      CALL BFWR(IUN,NBUFL,IW(INIW))
      GOTO 10
   12 NOUT(I)=-IUN
   14 CONTINUE
C----- DELETE LAST EVENT AND MAKE GARBAGE COLLECTION
   20 CALL BSLT
      CALL BDLG
C----- CHECK TIME AND NR OF RECORDS
      IF(JUHR(LIMSEC).EQ.1) GOTO 22
      WRITE(6,102)
      CALL MSGTXT('TIMELIMIT')
      GOTO 40
   22 IF(LIMREC.EQ.0.OR.NREC.LT.LIMREC) GOTO 24
      WRITE(6,103)
      CALL MSGTXT('RECDLIMIT')
      GOTO 40
   24 NREC=NREC+1
C----- INPUT - READ NEXT EVENT
   30 MARKWR=0
      IF(IASW.NE.0) GOTO 34
   32 CALL BRDS(1,NBUFL,INIR)
      IF(INIR.EQ.0) GOTO 100
      CALL BFRD(1,IW(INIR),IW(INIR+1))
      IF(IW(INIR).GE.0) GOTO 32
      WRITE(6,104)
      GOTO 40
C----- ASSEMBLER READ
   34 CALL BRDS(IASW,NBUFL,INIR)
      IF(INIR.EQ.0) GOTO 100
      CALL ASRD(IW(INIR),NBT,NBUFL*4)
      IF(NBT.LT.0) GOTO 38
      IF(NBT.EQ.0) GOTO 36
      IF(NBT.GE.4*IW(INIR)+4) GOTO 34
      IF(NBT.EQ.2*IW(INIR)+4) GOTO 34
   36 IW(INIR)=0
      GOTO 34
   38 CALL ASCL
      WRITE(6,104)
C----- END OF INPUT - WRITE LAST BUFFER
   40 CALL BMLT(0,DUMMY)
      IF(MARKWR.LE.0) GOTO 46
      DO 44 I=1,MARKWR
      IUN=IABS(NOUT(I))
      IF(IUN.EQ.0) GOTO 44
   42 CALL BWRS(IUN,NBUFL,INIW)
      IF(INIW.EQ.0) GOTO 44
      CALL BFWR(IUN,NBUFL,IW(INIW))
   44 CONTINUE
C----- MARK END OF INPUT
   46 MARK=1
      MARKWR=-1
      GOTO 100
C----- RETURN
      ENTRY BSEW(MARK)
C----- OUTPUT - DEFINE MARKER FOR OUTPUT
      IF(MARK.EQ.0) GOTO 100
      MARKA=IABS(MARK)
      IF(MARKWR.LE.0) GOTO 52
      DO 50 I=1,MARKWR
      IF(MARKA.EQ.IABS(NOUT(I))) GOTO 54
   50 CONTINUE
      IF(MARKWR.EQ.3) GOTO 100
   52 MARKWR=MARKWR+1
      IF(MARKWR.LE.0) MARKWR=1
      I=MARKWR
   54 NOUT(I)=MARK
      GOTO 100
C
      ENTRY BSET(MARK)
      LIMSEC=MARK
      GOTO 100
C
      ENTRY BSEL(MARK)
      LIMREC=MARK
  100 RETURN
  101 FORMAT('0++++ BSEQ START           -  END WILL BE AFTER',I6,
     1   ' RECORDS OR',I3,' SECONDS BEFORE TIMEOVFL'/)
  102 FORMAT('0++++ BSEQ END OF READING  -  TIME LIMIT REACHED'/)
  103 FORMAT('0++++ BSEQ END OF READING  -  RECORD LIMIT REACHED'/)
  104 FORMAT('0++++ BSEQ END OF READING  -  END-OF-DATA'/)
      END
